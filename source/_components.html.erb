<script type="text/ruby">

class CodeMirror < React::Component::Base
  param :code, type: String
  define_state :error_message

  before_mount do
    state.error_message! ""
  end

  after_mount do
    @editor = `CodeMirror(document.getElementById("code"), {
      value: #{params.code},
      mode: "text/x-ruby",
      matchBrackets: true,
      lineNumbers: true,
      indentUnit: 2,
      theme: 'github'
    });`
    `#{@editor}.on('change', #{lambda {on_change} })`
    execute_code
  end

  render(DIV) do
    div(id: 'code')
    br
    div(id: 'result')
    p { state.error_message }
  end

  def on_change
    state.error_message! ""
    execute_code
  end

  after_mount   :execute_code
  after_update  :execute_code

  def execute_code
    compiled_code = Opal::Compiler.new(`#{@editor}.getValue()`).compile
    `ReactDOM.unmountComponentAtNode(document.getElementById("result"));`
    `eval(#{compiled_code})`
    Element['#result'].render{ Alfie() }
    rescue Exception => e
    @time_out = after(0.5) do
      state.error_message! e.message
    end
  end

end

class TestApp < React::Component::Base
  param :name
  before_mount { @timer = every(1) { force_update! } }
  render(DIV) do
    h1 {"The current time is #{Time.now}"}
    h2 { "here hello #{params.name}" }.on(:click) do
     alert "you clicked"
    end
  end
end

</script>
